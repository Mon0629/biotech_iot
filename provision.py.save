#!/usr/bin/env python3
import subprocess
from fastapi import FastAPI, Request, Background config.device_config from

app = FastAPI()

HOTSPOT_NAME = "BIOTECH"
HOTSPOT_PASSWORD = "momorevillame24"


def start_ap_mode():
    """Start NetworkManager hotspot for provisioning."""
    print("Starting AP Mode...")

    existing = subprocess.run(
        ["nmcli", "-t", "-f", "NAME", "connection", "show"],
        capture_output=True, text=True
    )

    if HOTSPOT_NAME not in existing.stdout:
        subprocess.run([
            "nmcli", "device", "wifi", "hotspot",
            "ifname", "wlan0",
            "con-name", HOTSPOT_NAME,
            "ssid", HOTSPOT_NAME,
            "password", HOTSPOT_PASSWORD
        ])
    else:
        subprocess.run(["nmcli", "connection", "up", HOTSPOT_NAME])


def stop_ap_mode():
    """Stop hotspot."""
    print("Stopping AP Mode...")
    subprocess.run(["nmcli", "connection", "down", HOTSPOT_NAME],
                   stderr=subprocess.DEVNULL, stdout=subprocess.DEVNULL)


def connect_to_wifi(ssid: str, password: str) -> bool:
    """Connect Pi to WiFi using NetworkManager."""
    print(f"Connecting to WiFi: {ssid}")

    # Delete old config
    subprocess.run(["nmcli", "connection", "delete", ssid],
                   stderr=subprocess.DEVNULL, stdout=subprocess.DEVNULL)

    # Attempt connection
    result = subprocess.run([
        "nmcli", "device", "wifi", "connect", ssid,
        "password", password, "ifname", "wlan0"
    ])

    return result.returncode == 0


def switch_wifi(ssid: str, password: str):
    """Background task: connect then kill hotspot."""
    print("Background task: switching WiFi...")

    success = connect_to_wifi(ssid, password)
    if success:
        print(f"Connected to {ssid}, shutting down AP mode...")
        stop_ap_mode()
    else:
        print(f"Failed to connect to {ssid}")


@app.post("/provision")
async def provision_wifi(request: Request, background_tasks: BackgroundTasks):
    data = await request.json()
    ssid = data.get("ssid")
    password = data.get("password")

    if not ssid or not password:
        return {"status": "error", "message": "SSID and password required"}

    # Trigger the switch AFTER sending the response
    background_tasks.add_task(switch_wifi, ssid, password)

    # Send response BEFORE breaking the hotspot
    return {"status": "ok", "message": f"Provisioning started for {ssid}"}


if __name__ == "__main__":
    # Check if Pi is already on a WiFi network
    check = subprocess.run(
        ["nmcli", "-t", "-f", "DEVICE,STATE", "device"],
        capture_output=True, text=True
    )
    wlan0_active = "wlan0:connected" in check.stdout

    if not wlan0_active:
        start_ap_mode()
    else:
        print("WiFi already connected. Skipping hotspot startup.")

    uvicorn.run(app, host="0.0.0.0", port=5000)

